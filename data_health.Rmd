---
title: "Datathon UseR2019"
author: Diego Kozlowski
output: html_notebook
---


the data comes from [World Bank](https://datacatalog.worldbank.org/dataset/health-nutrition-and-population-statistics)

```{r setup}
library(tidyverse)
library(ggthemes)
library(ggridges)
library(ggrepel)
library(glue)
library(magrittr)
library(treemapify)

```

```{r}
# Country_Series <- read_csv("data/HNP_StatsCountry-Series.csv")
Country <- read_csv("data/HNP_StatsCountry.csv")
data <- read_csv("data/HNP_StatsData.csv")
# FootNote <- read_csv("data/HNP_StatsFootNote.csv")
# Series_time <- read_csv("data/HNP_StatsSeries-Time.csv")
# Series <- read_csv("data/HNP_StatsSeries.csv")
```
I reorgnize the dataset, gathering the years, and nesting the different indicators.

Also, as my data analysis will be country-centered, the observations regarding country aggregates might obscure the analysis, and therefore I will remove them. For this, I will use the information in the `Country` dataset

After eye inspection, I realize that those observations where the _2-alpha code_ contains a number, are refering to supranational aggregates. The same stands for the _2-alpha code_ that starts with X and Z. But because some countries also starts with Z,like South Africa _ZA_, Zambia _ZM_ and Zimbabwe _ZW_, and they are all republics, I will re-filter the selection to skip them. Finally the 'OE' code stands for the OECD aggregate

```{r}
Country %>% 
  filter(str_detect(`2-alpha code`,'[0-9]|X.|Z.|OE'),!str_detect(`Long Name`,'Republic')) %>% 
  select(`Long Name`,`2-alpha code`)
```

I will use this for filtering the data. Also, I will rename the data to follow the [tidyverse style guide](https://style.tidyverse.org/), and add the information of _Region_ and _Income Group_

```{r}

regional_aggregates <- Country %>% 
  filter(str_detect(`2-alpha code`,'[0-9]|X.|Z.|OE|EU'),!str_detect(`Long Name`,'Republic')) %$%
  `Country Code`


data <- data %>% 
  gather(year, value, 5:ncol(.)) %>% 
  left_join(.,Country %>% select("Country Code","Region","Income Group")) %>% 
  select(indicator= `Indicator Name`,indicator_cod =`Indicator Code`, country=`Country Name`,cod=`Country Code`,year,value, region=Region, inc_group=`Income Group`) %>%
  filter(!is.na(value), !(cod %in% regional_aggregates)) %>% 
  mutate(year=as.numeric(paste(year))) %>% 
  group_by(indicator, indicator_cod) %>% 
  nest()

saveRDS(data,'data/data.rds')

data <- read_rds('data/data.rds')
```


with this amount of indicators, it is a good idea to build a datapanel on shiny. 

I will build the plot for the indicator of HIV's prevalence, and based on this, build the shiny app.

```{r}

dist_plot <- function(df, indicator_code, top_countries = F, bottom_countries = F, specific_countries = NA) {
  
  filt_data <- df %>% 
    filter(indicator_cod==indicator_code) %>% 
    unnest()
  
  
  selected_countries <- specific_countries
  
  if (top_countries) {

    top <- filt_data %>%
    group_by(country) %>%
    summarise(value = max(value)) %>%
    top_n(3, value) %$% country
  
    ifelse(length(top)<=4,selected_countries <- c(selected_countries,top), 
            warning('too many countries in the right tale'))
  }
  if (bottom_countries) {

    bottom <- filt_data %>%
    group_by(country) %>%
    summarise(value = min(value)) %>%
    top_n(-3, value) %$% country
  
    ifelse(length(bottom)<=4,selected_countries <- c(selected_countries,bottom), 
            warning('too many countries in the left tale'))
  }
    
  filt_data %>% 
        ggplot(. , aes(value, factor(year)))+
        geom_density_ridges(alpha = 0.2)+
        geom_text_repel(data = . %>%
                          filter(country %in% selected_countries),
                        aes(label = cod, color = country),
                        nudge_y = 0.5, fontface = "bold")+
        theme_tufte()+
        theme(legend.position = "bottom")+
        scale_color_gdocs() +
        scale_fill_gdocs() +
        labs(y = "AÃ±o",
             title= glue('{unique(filt_data$indicator)}'))

}

dist_plot(df = data,indicator_code = 'SH.DYN.AIDS.ZS',top_countries = T)

```

This plot shows the distribution of HIV prevalence by year, and it highlights the top 3 countries. We can se that the distribution doesn't change too mach, although it more platykurtic for the last years. Nonetheless, there is a big change in those countries that are at the right tale of the distribution. Botswana and Eswatini had a dramatic increase in the percentage of people infected by HIV since the begining of the serie. Zimbabwe, on the other hand, although hading a significant amount of people infected, has decreased over the years.


For other indicators maybe it's more interesting to show the least 3. That's why I add the option to the function.


```{r}
data[str_detect(data$indicator_cod, 'SH.DYN.AIDS.ZS'),1:2]
```


For example for the indicator _Female headed households (% of households with a female head)_ its interesting to see the least percentage of female headed households

```{r}
dist_plot(data,indicator_code = 'SP.HOU.FEMA.ZS',bottom_countries = T)
```

We can se that the distributions shift a lot from year to year, presumably due to the smaller amount of data available. In order to corroborate this, I'll check the data density in the two different datasets:

```{r}
data %>% 
  filter(indicator_cod %in% c('SH.DYN.AIDS.ZS','SP.HOU.FEMA.ZS')) %>% 
  unnest() %>% 
  group_by(indicator) %>% 
  summarise(n=n())
```

As we supossed, the amount of information available for the indicator on Female headed housholds y much less that in the other. Nonetheless we can see that for those countries on which we do have data, Bangladesh has a low rate of female in the head of their housholds, never reaching even the 20%.

Another interesting example of use is for the Total Population by country.

```{r}

dist_plot(data,indicator_code = 'SP.POP.TOTL', top_countries = T)

```

We can se that the three most populated countries are the United States, India and China. But for this, It might be better a different kind of visualization, Like Treemaps.

For this, I will use the library [_treemapify_](https://CRAN.R-project.org/package=treemapify), David Wilkins (2018)


```{r}

grow_treemap <- function(df,indicator_code, yr=2016, group='inc_group') {
  
df %>% 
    filter(indicator_cod==indicator_code) %>% 
    unnest() %>% 
    filter(year==yr) %>% 
    ggplot(., aes_string(area = 'value',label = 'cod',subgroup = group, fill= group)) + 
    geom_treemap(fixed = TRUE)+
    geom_treemap_subgroup_border(color='grey', fixed = T)+
    geom_treemap_text(colour = "black", place = "left",
                        grow = F, fixed =  TRUE)+
    geom_treemap_subgroup_text(aes_string(label=group),colour = "white",alpha=0.6, place = "top",
                        grow = F, fixed =  TRUE, reflow=T)+
      labs(title= glue("Treemap, year {yr}"))+
      theme_tufte()+
      theme(legend.position = 'none',
            strip.text = element_text(family="Times", face="bold", size=20))

}



grow_treemap(data,indicator_code = 'SP.POP.TOTL',yr=2016, group = 'region' )
```

this is a much more usefull representation for analyzing this kind of data. Here we can see the distribution of population by region, and the most populated countries for each region. Again China and India excel, but we can have a better apreciation of the relative size of the United States with respect of this other two countries, in terms of population.


with this two visualizations, I will build a shiny app that will allowed the users explore data in a more visual way.




